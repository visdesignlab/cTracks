import React from 'react'
import hamradio from 'hamradio'

import HiglassUI from './HiglassUI'
import CNVTable from './CNVTable'
import ChromView from './ChromView'
import TracksMenu from './TracksMenu'
import ServerAdd from './ServerAdd'
import RegisterURL from './RegisterURL'
import ResilientData from './ResilientData'

import './CTracksComp.css'


class CTracksComp extends React.Component {
  constructor (props) {
    super(props);

    this.state = {
      expanded: true,
      tracks: ResilientData.tracks.get(),
      servers: ResilientData.servers.get(),
      variants: ResilientData.variants.get(),
      tools: ResilientData.tools.get()
    }
    this.subscriptions = this.makeSubscriptions()
  }

  componentWillUnmount() {
    this.subscriptions.forEach(sub => sub.unsubscribe())
  }

  makeSubscriptions() {
    return [
      hamradio.subscribe(
        'track/add',
        (name, data) => {
          this.setState({tracks: ResilientData.tracks.set(data)})
        }
      ),
      hamradio.subscribe(
        'track/modify',
        (name, data) => {
          this.setState({tracks: ResilientData.tracks.set(data)})
        }
      ),
      hamradio.subscribe(
        'track/remove',
        (name, data) => {
          this.setState({
            tracks: ResilientData.tracks.remove(data.row, data.uid)
          })
        }
      ),
      hamradio.subscribe(
        'server/add',
        (name, data) => {
          this.setState({
            servers: ResilientData.servers.add(data)
          })
        }
      ),
      hamradio.subscribe(
        'tools',
        (name, data) => {
          this.setState({
            tools: ResilientData.tools.set(data)
          })
        }
      )
    ]
  }

  hideTools = () => {
    this.setState({expanded: false})
  }

  showTools = () => {
    this.setState({expanded: true})
  }

  render() {
    return (
      <div className = "TopContainer">

        {Object.values(this.state.tools).some(item => item) && this.state.expanded && <div className="LeftPanel">
          {this.state.tools.zoom && <div className="Box PanelBox">
            <ChromView
              chromInfo = {this.props.chromInfo}
            />
          </div>}
          {this.state.tools.servers && <div className="Box PanelBox">
            <ServerAdd
              servers={this.state.servers}
            />
          </div>}
          {this.state.tools.urls && <div className="Box PanelBox">
            <RegisterURL
              servers={this.state.servers}
            />
          </div>}
          {this.state.tools.tracks && <div className="Box PanelBox">
            <TracksMenu
              tracks={this.state.tracks}
              servers={this.state.servers}
            />
          </div>}
        </div>}

        {Object.values(this.state.tools).some(item => item) && <div className = "Expander">
          {this.state.expanded
            ? <div className = "ExpandButton" onClick={this.hideTools}><i className="fas fa-chevron-left"/></div>
            : <div className = "ExpandButton" onClick={this.showTools}><i className="fas fa-chevron-right"/></div>
          }
        </div>}

        <div className = "RightPanel">
          <div className = "Box">
            <HiglassUI
              uid={this.props.uid}
              chromInfo={this.props.chromInfo}
              tracks={this.state.tracks}
            />
          </div>
          {!!this.state.variants.length &&
            <div className = "Box">
              <CNVTable
                variants={this.state.variants}
              />
            </div>
          }
        </div>

      </div>
    )
  }
}

export default CTracksComp;
