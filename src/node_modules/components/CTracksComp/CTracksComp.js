import React from 'react'
import hamradio from 'hamradio'

import viewconfig from './utils/viewconfig'
import HiglassUI from './HiglassUI'
import CNVTable from './CNVTable'
import ChromView from './ChromView'
import TracksMenu from './TracksMenu'
import ServerAdd from './ServerAdd'
import RegisterURL from './RegisterURL'
import ResilientData from './ResilientData'

import './CTracksComp.css'


class CTracksComp extends React.Component {
  constructor (props) {
    super(props);

    this.state = {
      expanded: true,
      tracks: ResilientData.tracks(),
      servers: ResilientData.servers(),
      variants: ResilientData.variants(),
      tools: ResilientData.tools()
    }
    this.subscriptions = this.makeSubscriptions()
  }

  componentWillUnmount() {
    this.subscriptions.forEach(sub => sub.unsubscribe())
  }

  makeSubscriptions() {
    return [
      hamradio.subscribe(
        'track/add',
        (name, data) => {
          this.updateTrack(data)
        }
      ),
      hamradio.subscribe(
        'track/modify',
        (name, data) => {
          this.updateTrack(data)
        }
      ),
      hamradio.subscribe(
        'track/remove',
        (name, data) => {
          this.setState({
            tracks: this.state.tracks.filter(track => track.track.uid !== data)
          })
        }
      ),
      hamradio.subscribe(
        'server/add',
        (name, data) => {
          this.setState({
            servers: this.state.servers.concat([data])
          })
        }
      ),
      hamradio.subscribe(
        'tools',
        (name, data) => {
          console.log('tools', data)
          this.setState({
            tools: Object.assign({}, this.state.tools, data)
          })
        }
      )
    ]
  }

  updateTrack = (newTrack) => {
    let trackIndex = this.state.tracks.findIndex(track => track.track.uid === newTrack.track.uid)
    let tracks = (trackIndex === -1)
      ? [
          ...this.state.tracks,
          newTrack
        ]
      : this.state.tracks.map((orig, index) => index !== trackIndex ? orig : newTrack)
    this.setState({
      tracks: viewconfig.sortTracks(tracks)
    })
  }

  hideTools = () => {
    this.setState({expanded: false})
  }

  showTools = () => {
    this.setState({expanded: true})
  }

  render() {
    return (
      <div className = "TopContainer">

        {Object.values(this.state.tools).some(item => item) && this.state.expanded && <div className="LeftPanel">
          <div className="Box PanelBox">
            {this.state.tools.zoom && <ChromView
              chromInfo = {this.props.chromInfo}
            />}
          </div>
          <div className="Box PanelBox">
            {this.state.tools.servers && <ServerAdd
              servers={this.state.servers}
            />}
          </div>
          <div className="Box PanelBox">
            {this.state.tools.urls && <RegisterURL
              servers={this.state.servers}
            />}
          </div>
          <div className="Box PanelBox">
            {this.state.tools.tracks && <TracksMenu
              tracks={this.state.tracks}
              servers={this.state.servers}
            />}
          </div>
        </div>}

        {Object.values(this.state.tools).some(item => item) && <div className = "Expander">
          {this.state.expanded
            ? <div className = "ExpandButton" onClick={this.hideTools}><i className="fas fa-chevron-left"/></div>
            : <div className = "ExpandButton" onClick={this.showTools}><i className="fas fa-chevron-right"/></div>
          }
        </div>}

        <div className = "RightPanel">
          <div className = "Box">
            <HiglassUI
              uid={this.props.uid}
              chromInfo={this.props.chromInfo}
              tracks={this.state.tracks}
            />
          </div>
          {!!this.state.variants.length &&
            <div className = "Box">
              <CNVTable
                variants={this.state.variants}
              />
            </div>
          }
        </div>

      </div>
    )
  }
}

export default CTracksComp;
