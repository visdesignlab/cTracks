import tracks from './tracks'
import _ from 'lodash'

const emptyViewConfig = {
  editable: false,
  zoomFixed: false,
  trackSourceServers: ["http://higlass.io/api/v1"],
  exportViewUrl: "http://localhost:8989/api/v1/viewconfs/",
  zoomLocks: {
    locksByViewUid: {},
    locksDict: {}
  },
  locationLocks: {
    locksByViewUid: {},
    locksDict: {}
  },
  views: []
}

const zoomChrom1 = [0, 249250621]
const zoomFullChrom = [0, 3095693981]

const genomePositionSearchBox = {
  autocompleteId: "OHJakQICQD6gTD7skx4EWA",
  autocompleteServer: "http://higlass.io/api/v1",
  chromInfoId: "b37",
  chromInfoServer: "http://higlass.io/api/v1",
  visible: true
}

function combinedTrackTemplate (track) {
  return {
    type: "combined",
    uid: track.uid,
    height: 40,
    options: {},
    contents: Object.values(track.tilesets).map(tileset => (
      {
        ...tileset,
        options: _.merge({}, tileset.options, {name: track.label ? track.label : undefined}),
        uid: `${track.uid}-${tileset.uid}`
      }
    ))
  }
}

function globalTrackTemplate (track) {
  let hgTrack = combinedTrackTemplate(track)
  hgTrack.contents.push({
    "uid": `${track.uid}-projection`,
    "type": "viewport-projection-horizontal",
    "fromViewUid": "demo-focus",
    "options": {
      "projectionFillColor": "#777",
      "projectionStrokeColor": "#777",
      "projectionFillOpacity": 0.3,
      "projectionStrokeOpacity": 0.3
    },
    "name": "Viewport Projection",
    "position": "top"
  })
  return hgTrack
}

function computeOverlays(tracks, features, highlights) {
  const overlayableTrack = uid => !([
    'bpRZDog1QQuZ7DmLfsKwXw', // chromosomeAxisTrack
    'NaYcUhtrQyeQhqz9gJOjxQ'  // geneAnnotationsHG19Track
  ].includes(uid))
  
  let overlaid = tracks
    .filter(track => overlayableTrack(track.uid))
    .map(track => track.uid)
    .concat(tracks
      .filter(track => overlayableTrack(track.uid))
      .flatMap(track => track.contents.map(track => track.uid)))

  return [{
    uid: `chroms-overlay`,
    type: 'chromosome-grid',
    includes: overlaid,
    chromInfoPath: 'https://s3.amazonaws.com/pkerp/public/chromSizes.tsv',
    options: {
      lineStrokeWidth: 1,
      lineStrokeColor: 'black'
    }
  }].concat(
    Object.keys(features).map(featureset => ({
      uid: `${featureset}-overlay`,
      includes: overlaid,
      options: {
        extent: features[featureset].locations,
        fillColor: features[featureset].color
      }
    }))
  ).concat(!highlights ? [] : [
    {
      uid: `highlight-overlay`,
      includes: overlaid,
      options: {
        extent: highlights
      }
    }
  ])
}

function globalView (uid, globalTracks, features, highlights) {
  return {
    uid: `${uid}-global`,
    initialXDomain: zoomFullChrom,
    initialYDomain: zoomFullChrom,
    xDomainLimits: zoomFullChrom,
    yDomainLimits: zoomFullChrom,
    zoomLimits: [1, 1],
    genomePositionSearchBox,
    layout: {
      w: 12,
      h: 7,
      x: 0,
      y: 0,
      i: "eN9c0VphSmOaptnJ6cOTdg",
      moved: false,
      static: false
    },
    tracks: {
      top: globalTracks,
      left: [],
      center: [],
      right: [],
      bottom: []
    },
    overlays: computeOverlays(globalTracks, features, highlights)
  }
}

function focusView (uid, focusTracks, features, highlights)
{
  return {
    uid: `${uid}-focus`,
    initialXDomain: zoomChrom1,
    initialYDomain: zoomChrom1,
    genomePositionSearchBox,
    layout: {
      w: 12,
      h: 8,
      x: 0,
      y: 7,
      i: "cc",
      moved: false,
      static: false
    },
    tracks: {
      top: focusTracks,
      left: [],
      center: [],
      right: [],
      bottom: []
    },
    overlays: computeOverlays(focusTracks, features, highlights)
  }
}

function setOverlay(metaViewConfig, highlights) { // currently we assume the highlight will be on the bottom set of tracks, we can add a param later to amend that
  metaViewConfig.highlights = highlights
  return metaViewConfig
}

function sortTracks(tracksToSort) {
  return tracksToSort.sort((a, b) => a.order < b.order ? -1 : a.order > b.order ? 1 : 0)
}

function generateViewConfig(metaViewConfig) {
  let globalTracks = [
    tracks.chromosomeAxisTrack
  ].concat(
    sortTracks(Object.values(metaViewConfig.tracks))
      .filter(track => track.global)
      .map(track => globalTrackTemplate(track))
  )

  let focusTracks = [
    tracks.chromosomeAxisTrack,
    tracks.geneAnnotationsHG19Track
  ].concat(
    sortTracks(Object.values(metaViewConfig.tracks))
      .filter(track => track.focus)
      .map(track => combinedTrackTemplate(track))
  )

  return JSON.parse(JSON.stringify({
    ...emptyViewConfig,
    views: [
      globalView(metaViewConfig.uid, globalTracks, metaViewConfig.features, metaViewConfig.highlights),
      focusView(metaViewConfig.uid, focusTracks, metaViewConfig.features, metaViewConfig.highlights)
    ]
  }))
}

export default {
  generateViewConfig,
  setOverlay,
  sortTracks
}
